{% extends "base.html" %}

{% block title %}Clusters Tranches - Pricing{% endblock %}

{% block extra_css %}
<style>
    .cluster-viz {
        min-height: 600px;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
    }
    .tranche-card {
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Visualisation des Clusters par Tranches</h1>
<p class="text-muted">Clustering K-means sur Z-Spread par tranches de Risk Mid (m√©thode courbe verte)</p>

{% if error %}
<div class="alert alert-danger">
    {{ error }}
</div>
{% else %}

<!-- Contr√¥les -->
<div class="card mb-4">
    <div class="card-header">
        <h5>Param√®tres de Clustering</h5>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('pricing.clusters_tranches') }}">
            <div class="row">
                <div class="col-md-6">
                    <label for="n_clusters_spread" class="form-label">Clusters Z-Spread</label>
                    <input type="number" class="form-control" id="n_clusters_spread"
                           name="n_clusters_spread" value="{{ n_clusters_spread }}"
                           min="2" max="6">
                    <small class="text-muted">Nombre de groupes par spread dans chaque tranche</small>
                </div>

                <div class="col-md-6">
                    <label for="seniority" class="form-label">S√©niorit√©</label>
                    <select class="form-select" id="seniority" name="seniority">
                        {% for sen in available_seniorities %}
                        <option value="{{ sen }}" {% if sen == selected_seniority %}selected{% endif %}>
                            {{ sen }}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">S√©niorit√© pour l'analyse</small>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Recalculer</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Visualisation -->
<div class="card">
    <div class="card-header">
        <h5>Clustering par Tranches - {{ selected_seniority }}</h5>
    </div>
    <div class="card-body">
        <div class="cluster-viz">
            <div class="alert alert-info">
                <strong>üìä Graphique de Clustering par Tranches</strong><br>
                <p>Ce graphique affichera :</p>
                <ul>
                    <li>Les points de march√© de tous les √©metteurs</li>
                    <li>S√©paration par tranches de Risk Mid: [0-1), [1-3), [3-5), [5-7), [7-10), [10+)</li>
                    <li>Clustering K-means sur le Z-Spread dans chaque tranche</li>
                    <li>Contours color√©s autour de chaque cluster</li>
                    <li>Lignes verticales s√©parant les tranches</li>
                </ul>
                <p class="mb-0 small">
                    <em>M√©thode : K-means sur Z-Spread, appliqu√© ind√©pendamment dans chaque tranche de Risk Mid.</em>
                </p>
            </div>

            <div id="plotly-clusters-tranches"></div>
        </div>
    </div>
</div>

<!-- Statistiques par tranche -->
<div class="row mt-4">
    <div class="col-12">
        <h4>Statistiques par Tranche</h4>
    </div>
</div>

<div class="row">
    {% set tranches = [
        {'name': '[0-1)', 'min': 0, 'max': 1},
        {'name': '[1-3)', 'min': 1, 'max': 3},
        {'name': '[3-5)', 'min': 3, 'max': 5},
        {'name': '[5-7)', 'min': 5, 'max': 7},
        {'name': '[7-10)', 'min': 7, 'max': 10},
        {'name': '[10+)', 'min': 10, 'max': 15}
    ] %}

    {% for tranche in tranches %}
    <div class="col-md-4">
        <div class="card tranche-card">
            <div class="card-header">
                <strong>Tranche {{ tranche.name }}</strong>
            </div>
            <div class="card-body">
                <p class="mb-1"><strong>Points:</strong> <span class="badge bg-info">N/A</span></p>
                <p class="mb-1"><strong>Z-Spread:</strong> N/A - N/A bp</p>
                <p class="mb-0 small text-muted">R√©partition: N/A</p>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Description de la m√©thode -->
<div class="card mt-4">
    <div class="card-header">
        <h5>M√©thode de Clustering</h5>
    </div>
    <div class="card-body">
        <h6>Comment fonctionne le clustering par tranches ?</h6>
        <ol>
            <li><strong>Division en tranches:</strong> Les points sont divis√©s en tranches de Risk Mid ([0-1), [1-3), [3-5), [5-7), [7-10), [10+))</li>
            <li><strong>Clustering dans chaque tranche:</strong> K-means est appliqu√© sur le Z-Spread dans chaque tranche ind√©pendamment</li>
            <li><strong>Identification des clusters:</strong> Pour chaque √©metteur, on identifie √† quel cluster appartiennent ses points dans chaque tranche</li>
            <li><strong>Construction de la courbe verte:</strong> La courbe verte est construite en moyennant les courbes de chaque tranche, pond√©r√©es par le nombre de points de l'√©metteur dans cette tranche</li>
        </ol>

        <h6 class="mt-3">Diff√©rence avec le clustering rating (courbe jaune) :</h6>
        <ul>
            <li><strong>Courbe jaune:</strong> Clustering Ward sur le rating (Note) de l'√©metteur ‚Üí Identifie les √©metteurs similaires par notation</li>
            <li><strong>Courbe verte:</strong> Clustering K-means sur le Z-Spread par tranches ‚Üí Identifie les niveaux de spread similaires par maturit√©</li>
        </ul>
    </div>
</div>

<!-- Tableau d√©taill√© -->
<div class="card mt-4">
    <div class="card-header">
        <h5>D√©tail des Clusters</h5>
    </div>
    <div class="card-body">
        <p class="text-muted">
            Le tableau d√©taillera pour chaque point :
        </p>
        <ul>
            <li>√âmetteur</li>
            <li>Risk Mid</li>
            <li>Z-Spread</li>
            <li>Tranche de Risk Mid</li>
            <li>Num√©ro du cluster attribu√© dans sa tranche</li>
        </ul>
    </div>
</div>

<div class="alert alert-warning mt-4">
    <strong>‚ö†Ô∏è Note:</strong> La visualisation compl√®te avec graphiques Plotly et contours color√©s sera ajout√©e dans une prochaine version.
    Le backend de clustering par tranches est d√©j√† impl√©ment√© et utilis√© dans la page "Construction des Courbes" (courbe verte).
</div>

{% endif %}
{% endblock %}

{% block extra_js %}
<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>

<script>
// TODO: Impl√©menter la visualisation Plotly avec les donn√©es de clustering par tranches
// Les calculs sont faits dans le backend (utilis√©s pour la courbe verte)

console.log("Clusters Tranches - Visualisation √† impl√©menter");
console.log("Param√®tres: n_clusters_spread={{ n_clusters_spread }}, seniority={{ selected_seniority }}");
</script>
{% endblock %}
